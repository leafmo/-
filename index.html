<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRPG 角色創造程式 - 羊皮捲風格</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for a medieval book aesthetic */
        body {
            font-family: 'Georgia', serif; /* A classic serif font for an older feel */
            background-color: #4a2c0f; /* Dark brown, reminiscent of old wood/leather */
            background-image: url('https://placehold.co/1920x1080/4a2c0f/4a2c0f?text='); /* Placeholder for a subtle wood texture */
            background-size: cover;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
            color: #3e2723; /* Dark brown text for readability on light backgrounds */
        }

        /* Main container to mimic a book - now with parchment style */
        .book-container {
            background-color: #fbf8e8; /* Warmer, yellowish parchment color */
            border: 10px solid #8b4513; /* Saddle brown for book cover/binding */
            border-radius: 15px; /* Softer, aged corners */
            box-shadow: 15px 15px 30px rgba(0, 0, 0, 0.5); /* Deeper shadow for book effect */
            padding: 30px;
            max-width: 800px; /* Adjusted max-width for a single-purpose creator */
            width: 100%;
            display: flex; /* Use flexbox for single column layout */
            flex-direction: column;
            gap: 1.5rem; /* 24px gap between sections */
            position: relative;
            overflow: hidden; /* Ensure content stays within book bounds */
            filter: sepia(0.1); /* Subtle sepia filter for an aged paper look */
        }

        /* Panel styling - now lighter parchment for inner pages */
        .panel {
            background-color: #fffaf0; /* Lighter parchment for inner pages */
            border: 2px solid #a0522d; /* Sienna for page borders */
            border-radius: 8px; /* Slightly rounded page corners */
            box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.2); /* Soft shadow for depth */
            padding: 25px;
        }

        /* Input, textarea, select styling - matching new parchment tones */
        input, textarea, select {
            background-color: #fffaf5; /* Very light parchment for input fields */
            border: 1px solid #8b4513; /* Darker brown for input borders */
            color: #3e2723; /* Dark brown text */
            transition: all 0.2s ease-in-out;
            border-radius: 4px; /* Slightly rounded for a softer look */
        }
        input:focus, textarea:focus, select:focus {
            border-color: #a0522d; /* Sienna for focus */
            box-shadow: 0 0 0 2px rgba(160, 82, 45, 0.5); /* Subtle focus ring */
        }

        /* Button styling */
        button {
            background-color: #a0522d; /* Sienna for buttons */
            color: white;
            font-weight: bold;
            padding: 12px 24px;
            border-radius: 6px;
            border: 2px outset #8b4513; /* Raised, carved look */
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease-in-out;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3); /* Subtle text shadow */
        }
        button:hover {
            background-color: #8b4513; /* Darker sienna on hover */
            transform: translateY(-1px); /* Slight lift */
            box-shadow: 3px 3px 7px rgba(0, 0, 0, 0.3);
        }
        button:disabled {
            background-color: #c0a080; /* Lighter brown for disabled */
            border-color: #a08060;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            text-shadow: none;
        }
        .btn-primary {
            background-color: #a0522d;
            border-color: #8b4513;
        }
        .btn-primary:hover {
            background-color: #8b4513;
        }
        .btn-success {
            background-color: #047857; /* Darker emerald for success */
            border-color: #065f46;
        }
        .btn-success:hover {
            background-color: #065f46;
        }

        /* Headings and list titles */
        h2 {
            font-family: 'Times New Roman', serif; /* More formal heading font */
            color: #3e2723; /* Dark brown for headings */
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1); /* Subtle embossed effect */
        }
        h3 {
            font-family: 'Times New Roman', serif;
            color: #3e2723; /* Dark brown for subheadings */
        }

        /* Text colors for specific elements */
        .text-purple-400 {
            color: #3e2723; /* Dark brown for main headings */
        }
        .text-purple-300 {
            color: #3e2723; /* Dark brown for subheadings */
        }
        .text-dark-text {
            color: #3e2723; /* Dark brown for primary text */
        }
        .text-dark-text-secondary {
            color: #6d4c41; /* Slightly lighter brown for secondary text */
        }
        .text-green-300 { /* Success messages */
            color: #046c4e;
        }
        .text-red-300 { /* Error messages */
            color: #881313;
        }
        .text-gray-400 { /* Placeholder text and log entries */
            color: #6d4c41; /* Darker brown for faded text */
        }

        /* Skill checkbox specific styling */
        .skill-checkbox-container {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        .skill-checkbox-container input[type="checkbox"] {
            margin-right: 8px;
            width: 18px; /* Larger checkbox */
            height: 18px;
            accent-color: #a0522d; /* Sienna accent for checked state */
        }
        .skill-checkbox-container label {
            font-size: 0.95rem;
            color: #3e2723;
            cursor: pointer;
        }
        .skill-checkbox-container input[type="checkbox"]:disabled + label {
            color: #6d4c41; /* Faded text for disabled skills */
            font-style: italic;
        }

        /* Pop-out message styling */
        .pop-out-message {
            position: absolute;
            background-color: #f0e68c; /* Khaki/parchment color */
            border: 2px solid #a0522d;
            border-radius: 8px;
            padding: 10px 20px;
            font-size: 1.1rem;
            font-weight: bold;
            color: #3e2723;
            text-align: center;
            white-space: nowrap;
            opacity: 0;
            transform: translateY(20px) scale(0.8);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
            z-index: 1000; /* Ensure it's on top */
            box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.3);
        }

        .pop-out-message.active {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    </style>
</head>
<body class="bg-gray-900 flex items-center justify-center min-h-screen p-4">
    <div class="book-container">

        <!-- Character Creation Panel -->
        <div class="panel p-6 rounded-xl">
            <h2 id="mainTitle" class="text-3xl font-extrabold mb-6 text-center text-purple-400 cursor-pointer">✨ 創造您的角色</h2>
            
            <div class="mb-4">
                <label for="charName" class="block text-sm font-medium mb-1 text-dark-text">角色名稱:</label>
                <input type="text" id="charName" class="w-full p-3 rounded-lg" placeholder="輸入角色名稱">
            </div>

            <!-- Player Name Input -->
            <div class="mb-4">
                <label for="playerName" class="block text-sm font-medium mb-1 text-dark-text">玩家名稱:</label>
                <input type="text" id="playerName" class="w-full p-3 rounded-lg" placeholder="輸入玩家名稱">
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="charRace" class="block text-sm font-medium mb-1 text-dark-text">種族:</label>
                    <select id="charRace" class="w-full p-3 rounded-lg">
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
                <div id="subraceContainer" class="hidden">
                    <label for="charSubrace" class="block text-sm font-medium mb-1 text-dark-text">亞種:</label>
                    <select id="charSubrace" class="w-full p-3 rounded-lg">
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="charClass" class="block text-sm font-medium mb-1 text-dark-text">職業:</label>
                    <select id="charClass" class="w-full p-3 rounded-lg">
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
                <div>
                    <label for="charBackground" class="block text-sm font-medium mb-1 text-dark-text">背景:</label>
                    <select id="charBackground" class="w-full p-3 rounded-lg">
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
            </div>

            <div class="mb-4">
                <label for="charAlignment" class="block text-sm font-medium mb-1 text-dark-text">陣營:</label>
                <select id="charAlignment" class="w-full p-3 rounded-lg">
                    <!-- Options will be populated by JavaScript -->
                    </select>
            </div>

            <h3 class="text-xl font-semibold mb-2 mt-4 text-purple-300">屬性值 (標準配點: 15, 14, 13, 12, 10, 8):</h3>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div><label for="assignStr" class="block text-sm font-medium mb-1 text-dark-text">力量 (STR):</label><select id="assignStr" class="w-full p-3 rounded-lg"></select></div>
                <div><label for="assignDex" class="block text-sm font-medium mb-1 text-dark-text">敏捷 (DEX):</label><select id="assignDex" class="w-full p-3 rounded-lg"></select></div>
                <div><label for="assignCon" class="block text-sm font-medium mb-1 text-dark-text">體質 (CON):</label><select id="assignCon" class="w-full p-3 rounded-lg"></select></div>
                <div><label for="assignInt" class="block text-sm font-medium mb-1 text-dark-text">智力 (INT):</label><select id="assignInt" class="w-full p-3 rounded-lg"></select></div>
                <div><label for="assignWis" class="block text-sm font-medium mb-1 text-dark-text">感知 (WIS):</label><select id="assignWis" class="w-full p-3 rounded-lg"></select></div>
                <div><label for="assignCha" class="block text-sm font-medium mb-1 text-dark-text">魅力 (CHA):</label><select id="assignCha" class="w-full p-3 rounded-lg"></select></div>
            </div>

            <div id="halfElfBonusContainer" class="hidden bg-yellow-100 p-4 rounded-lg border border-yellow-400 mb-4 text-dark-text-secondary">
                <p class="font-bold mb-2">半精靈額外加點:</p>
                <p class="mb-2">魅力 (CHA) 自動獲得 +2。</p>
                <p class="mb-2">請為兩個不同的非魅力屬性各選擇 +1:</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="halfElfBonus1" class="block text-sm font-medium mb-1">選擇屬性 1:</label>
                        <select id="halfElfBonus1" class="w-full p-3 rounded-lg"></select>
                    </div>
                    <div>
                        <label for="halfElfBonus2" class="block text-sm font-medium mb-1">選擇屬性 2:</label>
                        <select id="halfElfBonus2" class="w-full p-3 rounded-lg"></select>
                    </div>
                </div>
            </div>

            <h3 class="text-xl font-semibold mb-2 mt-4 text-purple-300">技能熟練選擇:</h3>
            <p id="skillProficiencyCounter" class="text-sm mb-4 text-dark-text-secondary">請選擇技能熟練。</p>
            <div id="skillProficiencyContainer" class="grid grid-cols-2 sm:grid-cols-3 gap-2 mb-4">
                <!-- Skill checkboxes will be populated here by JavaScript -->
            </div>

            <div class="flex flex-col sm:flex-row gap-4">
                <button id="createCharacterBtn" class="w-full btn-primary py-3 px-6 rounded-lg">
                    創造角色
                </button>
                <button id="randomCharacterBtn" class="w-full btn-success py-3 px-6 rounded-lg">
                    隨機生成角色
                </button>
            </div>

            <h3 class="text-xl font-semibold mb-2 mt-6 text-purple-300">您的新角色:</h3>
            <div id="newCharacterDisplay" class="panel p-4 rounded-lg min-h-[150px]">
                <p class="text-gray-400">角色資訊將顯示在這裡...</p>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Character Creation Elements
            const mainTitle = document.getElementById('mainTitle');
            const charNameInput = document.getElementById('charName');
            const playerNameInput = document.getElementById('playerName');
            const charRaceSelect = document.getElementById('charRace');
            const charSubraceSelect = document.getElementById('charSubrace');
            const subraceContainer = document.getElementById('subraceContainer');
            const charClassSelect = document.getElementById('charClass');
            const charBackgroundSelect = document.getElementById('charBackground');
            const charAlignmentSelect = document.getElementById('charAlignment');

            // Attribute Assignment Elements
            const assignStrSelect = document.getElementById('assignStr');
            const assignDexSelect = document.getElementById('assignDex');
            const assignConSelect = document.getElementById('assignCon');
            const assignIntSelect = document.getElementById('assignInt');
            const assignWisSelect = document.getElementById('assignWis');
            const assignChaSelect = document.getElementById('assignCha');
            const attributeSelects = {
                str: assignStrSelect,
                dex: assignDexSelect,
                con: assignConSelect,
                int: assignIntSelect,
                wis: assignWisSelect,
                cha: assignChaSelect
            };

            const halfElfBonusContainer = document.getElementById('halfElfBonusContainer');
            const halfElfBonus1Select = document.getElementById('halfElfBonus1');
            const halfElfBonus2Select = document.getElementById('halfElfBonus2');

            // Skill Proficiency Elements
            const skillProficiencyContainer = document.getElementById('skillProficiencyContainer');
            const skillProficiencyCounter = document.getElementById('skillProficiencyCounter');
            let maxClassProficiencies = 0; // Dynamic based on class
            let backgroundProficienciesSet = new Set(); // To store skills granted by background
            let classProficiencyOptions = new Set(); // To store skills allowed by class

            const createCharacterBtn = document.getElementById('createCharacterBtn');
            const randomCharacterBtn = document.getElementById('randomCharacterBtn');
            const newCharacterDisplay = document.getElementById('newCharacterDisplay');

            // Easter Egg Counters
            let randomButtonClickCount = 0; // For "Picky Adventurer" Easter Egg
            let titleClickCount = 0; // For Title Click Easter Egg
            let titleLastClickTime = 0;
            let titleClickTimeout = null;
            const titleClickThreshold = 5; // Number of clicks to trigger title easter egg

            // Continuous Click Easter Egg variables for newCharacterDisplay
            let displayClickCount = 0;
            let displayLastClickTime = 0;
            let displayClickTimeout = null;
            const displayClickThreshold = 5; // Number of clicks to trigger display easter egg
            const displayClickInterval = 1000; // Time in ms between clicks to count as continuous


            // --- Data for Dropdowns and Logic ---
            const races = [
                { name: "人類", subraces: [] },
                { name: "精靈", subraces: ["高地精靈", "木精靈", "黑暗精靈 (卓爾)"] },
                { name: "矮人", subraces: ["山地矮人", "丘陵矮人"] },
                { name: "半身人", subraces: ["萊特足半身人", "堅心半身人"] },
                { name: "地精", subraces: ["森林地精", "岩石地精"] },
                { name: "龍裔", subraces: [] },
                { name: "提夫林", subraces: [] },
                { name: "半獸人", subraces: [] },
                { name: "半精靈", subraces: [] }, // Special handling for Half-Elf
                { name: "侏儒", subraces: [] },
                { name: "肯庫", subraces: [] },
                { name: "蜥蜴人", subraces: [] },
                { name: "獸人", subraces: [] },
                { name: "貓人", subraces: [] },
                { name: "鳥人", subraces: [] },
                { name: "妖精", subraces: [] },
                { name: "哥布林", subraces: [] },
                { name: "狗頭人", subraces: [] }
            ];

            const classes = [
                "野蠻人", "吟遊詩人", "牧師", "德魯伊",
                "戰士", "武僧", "聖武士", "遊俠",
                "遊蕩者", "術士", "邪術師", "法師",
                "血騎士", "奇械師"
            ];

            const alignments = [
                "守序善良", "中立善良", "混亂善良",
                "守序中立", "絕對中立", "混亂中立",
                "守序邪惡", "中立邪惡", "混亂邪惡"
            ];

            const backgrounds = [
                "侍僧", "騙徒", "罪犯", "藝人",
                "民間英雄", "行會工匠", "隱士",
                "貴族", "野外生存者", "賢者",
                "士兵", "街頭流浪兒", "學徒",
                "偵探", "海員", "間諜"
            ];

            const standardArrayValues = [15, 14, 13, 12, 10, 8];
            let availableAttributeValues = [...standardArrayValues]; // Copy for manipulation
            let assignedAttributeValues = {
                str: null, dex: null, con: null, int: null, wis: null, cha: null
            };

            // Attributes for Half-Elf bonus (all except Charisma)
            const halfElfBonusAttributes = [
                { key: 'str', name: '力量 (STR)' },
                { key: 'dex', name: '敏捷 (DEX)' },
                { key: 'con', name: '體質 (CON)' },
                { key: 'int', name: '智力 (INT)' },
                { key: 'wis', name: '感知 (WIS)' }
            ];

            // All D&D 5e Skills with their governing attributes
            const allSkills = [
                { key: 'athletics', name: '運動', attribute: 'str' },
                { key: 'acrobatics', name: '技巧', attribute: 'dex' },
                { key: 'sleightOfHand', name: '巧手', attribute: 'dex' },
                { key: 'stealth', name: '隱匿', attribute: 'dex' },
                { key: 'arcana', name: '奧秘', attribute: 'int' },
                { key: 'history', name: '歷史', attribute: 'int' },
                { key: 'investigation', name: '調查', attribute: 'int' },
                { key: 'nature', name: '自然', attribute: 'int' },
                { key: 'religion', name: '宗教', attribute: 'int' },
                { key: 'animalHandling', name: '動物處理', attribute: 'wis' },
                { key: 'insight', name: '洞察', attribute: 'wis' },
                { key: 'medicine', name: '醫藥', attribute: 'wis' },
                { key: 'perception', name: '察覺', attribute: 'wis' },
                { key: 'survival', name: '生存', attribute: 'wis' },
                { key: 'deception', name: '欺瞞', attribute: 'cha' },
                { key: 'intimidation', name: '威嚇', attribute: 'cha' },
                { key: 'performance', name: '表演', attribute: 'cha' },
                { key: 'persuasion', name: '說服', attribute: 'cha' }
            ];

            // Mapping of backgrounds to the skills they grant proficiency in
            const backgroundProficienciesMap = {
                "侍僧": ["insight", "religion"],
                "騙徒": ["deception", "sleightOfHand"],
                "罪犯": ["deception", "stealth"],
                "藝人": ["acrobatics", "performance"],
                "民間英雄": ["animalHandling", "survival"],
                "行會工匠": ["insight", "persuasion"],
                "隱士": ["medicine", "religion"],
                "貴族": ["history", "persuasion"],
                "野外生存者": ["athletics", "survival"],
                "賢者": ["arcana", "history"],
                "士兵": ["athletics", "intimidation"],
                "街頭流浪兒": ["sleightOfHand", "stealth"],
                "學徒": ["arcana", "history"], // Example, adjust if specific
                "偵探": ["investigation", "insight"], // Example, adjust if specific
                "海員": ["athletics", "perception"], // Example, adjust if specific
                "間諜": ["deception", "stealth"] // Example, adjust if specific
            };

            // New map for class skill proficiencies
            // Each class has a 'count' of skills they can choose, and 'options' (an array of skill keys) they can choose from.
            // If 'options' is null or empty, it implies they can choose from any skill.
            const classSkillProficiencies = {
                "野蠻人": { count: 2, options: ["athletics", "intimidation", "animalHandling", "nature", "perception", "survival"] },
                "吟遊詩人": { count: 3, options: allSkills.map(s => s.key) }, // Any 3 skills
                "牧師": { count: 2, options: ["insight", "medicine", "persuasion", "religion"] },
                "德魯伊": { count: 2, options: ["animalHandling", "arcana", "insight", "medicine", "nature", "perception", "religion", "survival"] },
                "戰士": { count: 2, options: ["acrobatics", "animalHandling", "athletics", "history", "insight", "intimidation", "perception", "survival"] },
                "武僧": { count: 2, options: ["acrobatics", "athletics", "history", "insight", "religion", "stealth"] },
                "聖武士": { count: 2, options: ["athletics", "insight", "intimidation", "medicine", "persuasion", "religion"] },
                "遊俠": { count: 3, options: ["animalHandling", "athletics", "insight", "investigation", "nature", "perception", "stealth", "survival"] },
                "遊蕩者": { count: 4, options: ["acrobatics", "athletics", "deception", "insight", "intimidation", "investigation", "perception", "performance", "persuasion", "sleightOfHand", "stealth"] },
                "術士": { count: 2, options: ["arcana", "deception", "insight", "intimidation", "persuasion", "religion"] },
                "邪術師": { count: 2, options: ["arcana", "deception", "history", "intimidation", "investigation", "nature", "religion"] },
                "法師": { count: 2, options: ["arcana", "history", "insight", "investigation", "medicine", "religion"] },
                "血騎士": { count: 2, options: ["athletics", "acrobatics", "insight", "intimidation", "investigation", "perception", "stealth", "survival"] },
                "奇械師": { count: 2, options: ["arcana", "history", "investigation", "medicine", "sleightOfHand"] }
            };

            const generalEasterEggMessages = [
                "一個新的傳奇即將誕生！",
                "願您的骰子永遠是20點！",
                "小心地城中的史萊姆，它們比你想像的更黏！",
                "聽說遠方有龍的低語…",
                "您的冒險，從此刻開始！",
                "別忘了帶上10呎的桿子！",
                "有時候，最棒的寶藏是友誼…和金幣。",
                "你感覺到一股微風，耳邊似乎傳來了某個熟悉的聲音…『這是個陷阱！』",
                "當心那些會說話的寶箱！",
                "你的角色被一個神秘的鴨子注視著…",
                "你成功地避開了所有稅務！恭喜！",
                "小心，地城主正在磨他的牙齒！",
                "你發現了一枚閃閃發光的硬幣，上面刻著…你的臉？",
                "別忘了你的角色有時會需要休息！",
                "你的角色在創造過程中打了個哈欠。真是個有潛力的冒險者！",
                "你感覺到一股強烈的預感，今晚的晚餐會有派！",
                "一個小精靈從螢幕裡跳了出來，對你眨了眨眼，然後又消失了。",
                "你聽到了遠處傳來一陣微弱的歌聲，似乎在讚美你的角色！",
                "你找到了一雙隱形襪子，但你卻找不到它們！",
                "你的角色在夢中學會了如何騎乘獨角獸，雖然那只獨角獸是充氣的。",
                "你感覺到一股強烈的衝動，想把所有東西都塗成紫色。",
                "小心，你的角色可能會不小心掉進一個充滿地精的兔子洞！"
            ];

            const raceClassEasterEggs = {
                "人類-戰士": "標準組合，但別小看它的潛力！",
                "精靈-遊蕩者": "敏捷的身手，加上精靈的優雅，完美的組合！",
                "矮人-牧師": "堅韌的信仰，矮人牧師是隊伍的堅實後盾！",
                "半精靈-吟遊詩人": "天生的魅力，半精靈吟遊詩人將用歌聲征服世界！",
                "提夫林-邪術師": "與惡魔的契約，這將是一段充滿誘惑與力量的旅程！",
                "侏儒-奇械師": "小小的身軀，卻蘊藏著無限的發明創造力！",
                "龍裔-野蠻人": "狂暴的龍血，讓你的怒火燃燒吧！",
                "半獸人-戰士": "強大的力量與堅韌的意志，戰場上的猛獸！",
                "半身人-遊蕩者": "小巧的身軀與靈活的技巧，是潛入與偷竊的專家！",
                "精靈-法師": "經典的奧術施法者，願你的咒語永不失誤！",
                "人類-牧師": "信仰的傳播者，你的神明將引導你前行！",
                "矮人-戰士": "堅韌不拔的矮人戰士，準備好為榮譽而戰了嗎？",
                "半身人-遊俠": "森林中的追蹤者，沒有什麼能逃過你的眼睛！",
                "地精-遊蕩者": "小巧而狡猾，地精遊蕩者總能找到最佳的藏身之處！",
                "龍裔-聖武士": "龍血的聖騎士，你的誓言將如龍吼般響亮！",
                "提夫林-術士": "惡魔血脈的術士，駕馭你內心的力量吧！",
                "半獸人-野蠻人": "狂野的戰鬥者，讓你的怒吼震徹整個戰場！",
                "侏儒-德魯伊": "熱愛自然的侏儒，與森林中的生靈共舞！",
                "肯庫-武僧": "模仿大師的武術家，你的招式將變幻莫測！",
                "蜥蜴人-德魯伊": "冷靜的自然守護者，沼澤是你的家園！",
                "獸人-野蠻人": "強大的狂戰士，你的斧頭將無堅不摧！",
                "貓人-吟遊詩人": "喜歡故事和旅行的吟遊詩人，用歌聲點亮每個營火！",
                "鳥人-遊俠": "天空中的守護者，從高空俯瞰你的獵物！",
                "妖精-術士": "魔法天賦的妖精，你的魔法充滿了奇幻與驚喜！",
                "哥布林-遊蕩者": "狡猾的哥布林，沒有你打不開的鎖，只有你不想開的！",
                "狗頭人-法師": "聰明的狗頭人，別小看任何一個會施法的狗頭人！",
                "人類-吟遊詩人": "萬能的說書人，你的故事將傳遍大陸！",
                "精靈-德魯伊": "與森林共鳴的古老靈魂，精靈德魯伊是自然的化身。",
                "矮人-遊蕩者": "矮人中的異類？但他們開鎖的手藝可不輸任何人！",
                "半身人-牧師": "小小的身軀，大大的信仰，半身人牧師的祝福溫暖人心。",
                "地精-法師": "誰說地精不能施法？他們的咒語可能有點…爆炸性。",
                "龍裔-吟遊詩人": "龍的歌聲，既能激勵人心，也能震懾敵人！",
                "提夫林-牧師": "即使身負惡魔血脈，也能選擇侍奉光明，這需要多大的勇氣！",
                "半獸人-聖武士": "用強大的力量捍衛正義，半獸人聖武士是正義的化身。",
                "侏儒-遊蕩者": "小巧的身軀讓他們成為完美的間諜和盜賊！",
                "肯庫-德魯伊": "在森林中尋找自我，肯庫德魯伊的自然之道充滿奧秘。",
                "蜥蜴人-戰士": "冷血的戰士，他們的戰鬥方式直接而致命！",
                "獸人-牧師": "即使是獸人，也能找到信仰，並為部落帶來神聖的力量。",
                "貓人-遊蕩者": "靈活敏捷的貓人，他們的爪子和潛行能力無人能及！",
                "鳥人-牧師": "天空的使者，鳥人牧師將神的旨意帶給大地。",
                "妖精-遊蕩者": "調皮的妖精，他們的惡作劇總是讓人又愛又恨！",
                "哥布林-戰士": "數量就是力量！哥布林戰士雖然弱小，但團結起來也能造成威脅。",
                "狗頭人-法師": "聰明的狗頭人，別小看任何一個會施法的狗頭人！",
                // 新增的種族職業彩蛋
                "精靈-聖武士": "高貴的誓言，精靈聖武士的聖光將照亮黑暗！",
                "矮人-遊俠": "在山脈中追蹤獵物，矮人遊俠是堅韌的探險家！",
                "半身人-德魯伊": "與自然親近的小小守護者，半身人德魯伊的魔法充滿生機！",
                "地精-邪術師": "與古怪的實體簽訂契約，地精邪術師的魔法總是出乎意料！",
                "龍裔-法師": "龍的智慧與奧術的結合，龍裔法師的咒語將震撼人心！",
                "提夫林-吟遊詩人": "用魅惑的歌聲掩蓋惡魔的血脈，提夫林吟遊詩人是天生的說服者！",
                "半獸人-武僧": "將狂暴的力量轉化為精準的武術，半獸人武僧是戰鬥的藝術家！",
                "侏儒-術士": "侏儒的魔法天賦，加上天生的魅力，術士之路充滿驚喜！",
                "肯庫-戰士": "模仿強大戰士的技巧，肯庫戰士在戰場上學習成長！",
                "蜥蜴人-遊蕩者": "冷靜而隱秘的獵手，蜥蜴人遊蕩者在沼澤中無聲無息！",
                "獸人-法師": "打破刻板印象的獸人，他們的奧術力量不容小覷！",
                "貓人-牧師": "貓神的祝福，貓人牧師的治療術輕柔而有效！",
                "鳥人-術士": "天生擁有魔法血脈的鳥人，他們的咒語如同風暴般強大！",
                "妖精-聖武士": "以純真之心捍衛誓言，妖精聖武士是光明與歡樂的使者！",
                "哥布林-牧師": "即使是哥布林，也能找到信仰，並為他們的部落帶來微薄的神聖力量！",
                "狗頭人-吟遊詩人": "用蹩腳的歌聲和滑稽的表演來取悅他們的龍主，狗頭人吟遊詩人充滿了喜劇色彩！",
                // 新增更多種族職業彩蛋
                "人類-法師": "經典的奧術之路，人類的適應力讓他們能駕馭任何魔法！",
                "精靈-遊俠": "森林的守護者，精靈遊俠的箭術無人能及！",
                "矮人-聖武士": "堅不可摧的信仰，矮人聖武士是正義的磐石！",
                "半身人-術士": "小小的身軀蘊藏著強大的魔法天賦，別小看他們！",
                "地精-牧師": "即使是地精，也能找到信仰，為他們的部落帶來微不足道的祝福！",
                "龍裔-德魯伊": "龍的血脈與自然的連結，這將是狂野而強大的組合！",
                "提夫林-戰士": "惡魔的血統賦予你力量，用你的劍為自己正名！",
                "半獸人-吟遊詩人": "狂野的歌聲，半獸人吟遊詩人將用他們的獨特魅力征服聽眾！",
                "侏儒-牧師": "侏儒的信仰堅定而純粹，他們是小小的神聖使者！",
                "肯庫-遊蕩者": "天生的模仿者，肯庫遊蕩者能完美複製任何潛入技巧！",
                "蜥蜴人-聖武士": "冷靜而致命的誓言，蜥蜴人聖武士的判斷力無人能敵！",
                "獸人-術士": "獸人中的異類，他們的魔法天賦將震驚世界！",
                "貓人-戰士": "優雅的戰鬥風格，貓人戰士在戰場上如舞蹈般靈動！",
                "鳥人-吟遊詩人": "用歌聲翱翔天際，鳥人吟遊詩人將故事傳播到每個角落！",
                "妖精-法師": "妖精的魔法天賦與法師的學識結合，創造出奇妙的咒語！",
                "哥布林-奇械師": "哥布林也能發明創造？小心他們的小玩意兒會爆炸！",
                "狗頭人-邪術師": "與黑暗實體的契約，狗頭人邪術師的魔法充滿了狡詐！",
                "人類-德魯伊": "與自然親近的人類，他們的德魯伊之道充滿了適應性！",
                "精靈-武僧": "精靈的優雅與武僧的紀律，完美的平衡！",
                "矮人-術士": "矮人中的魔法異類，他們的術士力量源自古老的血脈！",
                "半身人-聖武士": "小小的身軀，大大的正義，半身人聖武士是無畏的守護者！",
                "地精-奇械師": "地精的發明總是充滿驚喜（或驚嚇），他們的奇械師之路充滿了混亂！",
                "龍裔-遊蕩者": "龍裔的強大身軀與遊蕩者的敏捷結合，是可怕的刺客！",
                "提夫林-遊俠": "在陰影中追蹤獵物，提夫林遊俠的復仇之路無人能擋！",
                "半獸人-牧師": "即使是半獸人，也能找到神聖的指引，為部落帶來信仰的力量！",
                "侏儒-吟遊詩人": "侏儒的幽默感與吟遊詩人的天賦，他們的故事總是充滿歡聲笑語！",
                "肯庫-奇械師": "肯庫的模仿天賦讓他們能快速掌握奇械術，創造出獨特的裝置！",
                "蜥蜴人-牧師": "冷靜而原始的信仰，蜥蜴人牧師是沼澤的守護者！",
                "獸人-聖武士": "獸人中的榮譽戰士，他們的誓言比鋼鐵更堅硬！",
                "貓人-術士": "貓人的神秘感與術士的魔法結合，他們的魅力無人能擋！",
                "鳥人-聖武士": "天空的聖騎士，鳥人聖武士用聖光淨化邪惡！",
                "妖精-奇械師": "妖精的奇思妙想與奇械術結合，創造出令人驚嘆的魔法裝置！",
                "哥布林-邪術師": "哥布林與黑暗力量的交易，他們的邪術充滿了惡意！",
                "狗頭人-牧師": "狗頭人對龍的崇拜，讓他們成為龍神的微小僕從！"
            };

            // Player Name Easter Eggs (now checks playerNameInput)
            const playerNameEasterEggs = {
                "冰凌": "雖然我們已經有個冰凌了，但相信她不介意有更多個...應該啦",
                "冰0": "雖然我們已經有個冰凌了，但相信她不介意有更多個...應該啦",
                "哥布林殺手": "你對哥布林的仇恨，將成為你冒險的動力！",
                "傑洛特": "嗯，你聞起來像個怪物殺手，還有點…丁香和醋味？",
                "卓爾精靈": "小心陽光！以及那些不信任卓爾的人。",
                "我的城鎮被鴨子燒毀了": "鴨子？這可真是個不尋常的悲劇。復仇的火焰在你的心中燃燒！",
                "我要成為一個龍廚師": "這是一個很有趣的職業選擇，希望你的食譜能讓龍也讚不絕口！",
                "我是dm": "等等，你怎麼在這裡？快回去準備你的模組！",
                // 新增的玩家名稱彩蛋
                "冒險家": "願您的旅途充滿驚奇與寶藏！",
                "英雄": "您的英勇事蹟將被吟遊詩人傳唱！",
                "傳奇": "一個傳奇的誕生，世界將為之顫抖！",
                "菜鳥": "別擔心，每個傳奇都從菜鳥開始！",
                "老手": "歡迎回來，老冒險家，這次又想挑戰什麼？",
                "路人甲": "即使是路人甲，也能成為故事的主角！",
                "測試員": "感謝您的測試，希望您玩得開心！",
                "貓貓": "一隻勇敢的貓貓踏上了冒險之旅", // 新增的貓貓彩蛋
                "樂五": "更多的樂五！他們會不會一起說好哦句點我們？", // 新增的樂五彩蛋
                "樂5": "更多的樂五！他們會不會一起說好哦句點我們？" // 新增的樂5彩蛋
            };


            // --- Helper Functions ---
            function getRandomElement(arr) {
                return arr[Math.floor(Math.random() * arr.length)];
            }

            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            function populateDropdown(selectElement, optionsArray, defaultValue = "") {
                const currentSelectedValue = selectElement.value; // Store current value
                selectElement.innerHTML = `<option value="">請選擇</option>`; // Always start with default
                let valueFound = false;

                optionsArray.forEach(option => {
                    const opt = document.createElement('option');
                    let optionValue, optionText;
                    if (typeof option === 'object' && option.name) {
                        optionValue = option.name;
                        optionText = option.name;
                    } else if (typeof option === 'object' && option.key && option.name) { // For halfElfBonusAttributes
                        optionValue = option.key;
                        optionText = option.name;
                    } else {
                        optionValue = option;
                        optionText = option;
                    }
                    opt.value = optionValue;
                    opt.textContent = optionText;
                    selectElement.appendChild(opt);
                    if (optionValue === defaultValue) {
                        valueFound = true;
                    }
                });

                // Set the selected value back if it's still a valid option or if a defaultValue was provided and found
                if (valueFound) {
                    selectElement.value = defaultValue;
                } else if (currentSelectedValue && optionsArray.some(opt => (typeof opt === 'object' ? opt.key : opt) === currentSelectedValue || (typeof opt === 'object' ? opt.name : opt) === currentSelectedValue || opt === currentSelectedValue)) {
                    // If the previously selected value is still in the new options, re-select it
                    selectElement.value = currentSelectedValue;
                } else {
                    selectElement.value = ""; // Otherwise, reset to "請選擇"
                }
            }

            function getAttributeModifier(score) {
                return Math.floor((score - 10) / 2);
            }

            // --- Attribute Assignment Logic (Standard Array) ---
            function updateAttributeDropdowns() {
                // For each attribute select, update its options
                for (const attrKey in attributeSelects) {
                    const selectElement = attributeSelects[attrKey];
                    const currentValue = assignedAttributeValues[attrKey];

                    // Clear existing options
                    selectElement.innerHTML = '<option value="">請選擇</option>';

                    // Add currently assigned value (if any) to the available list for this specific dropdown
                    if (currentValue !== null) {
                        const currentOpt = document.createElement('option');
                        currentOpt.value = currentValue;
                        currentOpt.textContent = currentValue;
                        selectElement.appendChild(currentOpt);
                    }

                    // Add all truly available values
                    availableAttributeValues.sort((a, b) => b - a).forEach(value => {
                        if (value !== currentValue) { // Don't add current value again if already added
                            const opt = document.createElement('option');
                            opt.value = value;
                            opt.textContent = value;
                            selectElement.appendChild(opt);
                        }
                    });

                    // Set the selected value back
                    if (currentValue !== null) {
                        selectElement.value = currentValue;
                    }
                }
            }

            // Attach event listeners for attribute assignment
            for (const attrKey in attributeSelects) {
                attributeSelects[attrKey].addEventListener('change', (event) => {
                    const newAssignedValue = event.target.value === "" ? null : parseInt(event.target.value);
                    const oldAssignedValue = assignedAttributeValues[attrKey];

                    // If there was an old value, return it to the available pool
                    if (oldAssignedValue !== null) {
                        availableAttributeValues.push(oldAssignedValue);
                    }

                    // If a new value is selected, remove it from the available pool
                    if (newAssignedValue !== null) {
                        const index = availableAttributeValues.indexOf(newAssignedValue);
                        if (index > -1) {
                            availableAttributeValues.splice(index, 1);
                        }
                    }

                    // Update the assigned value for this attribute
                    assignedAttributeValues[attrKey] = newAssignedValue;

                    // Re-render all attribute dropdowns
                    updateAttributeDropdowns();
                });
            }

            // --- Half-Elf Bonus Logic ---
            function updateHalfElfBonusDropdowns() {
                // Filter out CHA from options for the +1 bonuses
                const nonChaAttributes = halfElfBonusAttributes.filter(attr => attr.key !== 'cha');

                const selectedBonus1 = halfElfBonus1Select.value;
                const selectedBonus2 = halfElfBonus2Select.value;

                // Options for bonus 1: all non-CHA attributes, excluding selected bonus 2
                const optionsForBonus1 = nonChaAttributes.filter(attr => attr.key !== selectedBonus2);
                // Options for bonus 2: all non-CHA attributes, excluding selected bonus 1
                const optionsForBonus2 = nonChaAttributes.filter(attr => attr.key !== selectedBonus1);

                populateDropdown(halfElfBonus1Select, optionsForBonus1, selectedBonus1);
                populateDropdown(halfElfBonus2Select, optionsForBonus2, selectedBonus2);
            }

            halfElfBonus1Select.addEventListener('change', updateHalfElfBonusDropdowns);
            halfElfBonus2Select.addEventListener('change', updateHalfElfBonusDropdowns);

            // --- Race Selection Logic (for Subraces and Half-Elf) ---
            charRaceSelect.addEventListener('change', () => {
                const selectedRaceName = charRaceSelect.value;
                const selectedRace = races.find(r => r.name === selectedRaceName);

                // Handle Subraces
                if (selectedRace && selectedRace.subraces && selectedRace.subraces.length > 0) {
                    populateDropdown(charSubraceSelect, selectedRace.subraces);
                    subraceContainer.classList.remove('hidden');
                } else {
                    subraceContainer.classList.add('hidden');
                    charSubraceSelect.innerHTML = '<option value="">請選擇</option>'; // Clear subrace
                }

                // Handle Half-Elf Bonus
                if (selectedRaceName === "半精靈") {
                    halfElfBonusContainer.classList.remove('hidden');
                    // Populate with all attributes except CHA for the +1 bonuses initially
                    populateDropdown(halfElfBonus1Select, halfElfBonusAttributes.filter(attr => attr.key !== 'cha'));
                    populateDropdown(halfElfBonus2Select, halfElfBonusAttributes.filter(attr => attr.key !== 'cha'));
                    updateHalfElfBonusDropdowns(); // Ensure initial state is correct and filters correctly
                } else {
                    halfElfBonusContainer.classList.add('hidden');
                    halfElfBonus1Select.innerHTML = '<option value="">請選擇</option>';
                    halfElfBonus2Select.innerHTML = '<option value="">請選擇</option>';
                }
            });

            // --- Class Selection Logic (for Skill Proficiencies) ---
            charClassSelect.addEventListener('change', () => {
                updateSkillProficienciesBasedOnClassAndBackground();
            });

            // --- Background Selection Logic (for Skill Proficiencies) ---
            charBackgroundSelect.addEventListener('change', () => {
                updateSkillProficienciesBasedOnClassAndBackground();
            });

            // --- Skill Proficiency Logic ---
            function updateSkillProficienciesBasedOnClassAndBackground() {
                const selectedClass = charClassSelect.value;
                const selectedBackground = charBackgroundSelect.value;

                // Reset all skill proficiency states
                backgroundProficienciesSet.clear();
                classProficiencyOptions.clear();
                maxClassProficiencies = 0;

                // Apply class-based proficiencies
                if (selectedClass && classSkillProficiencies[selectedClass]) {
                    const classProf = classSkillProficiencies[selectedClass];
                    maxClassProficiencies = classProf.count;
                    if (classProf.options && classProf.options.length > 0) {
                        classProf.options.forEach(skillKey => classProficiencyOptions.add(skillKey));
                    } else {
                        // If no specific options, assume all skills are potential options for class choice
                        allSkills.forEach(skill => classProficiencyOptions.add(skill.key));
                    }
                }

                // Apply background-based proficiencies
                if (selectedBackground && backgroundProficienciesMap[selectedBackground]) {
                    const skillsFromBackground = backgroundProficienciesMap[selectedBackground];
                    skillsFromBackground.forEach(skillKey => backgroundProficienciesSet.add(skillKey));
                }

                renderSkillProficiencies();
            }

            function renderSkillProficiencies() {
                skillProficiencyContainer.innerHTML = '';
                allSkills.forEach(skill => {
                    const div = document.createElement('div');
                    div.className = 'skill-checkbox-container';

                    const isBackgroundProficient = backgroundProficienciesSet.has(skill.key);
                    const isClassOption = classProficiencyOptions.size === 0 || classProficiencyOptions.has(skill.key); // If class options are empty, assume all are options

                    // Check if it should be disabled (either by background or not a class option)
                    const isDisabled = isBackgroundProficient || !isClassOption;
                    // Check if it should be pre-checked (by background)
                    const isChecked = isBackgroundProficient;

                    div.innerHTML = `
                        <input type="checkbox" id="skill-${skill.key}" data-skill-key="${skill.key}"
                               ${isChecked ? 'checked' : ''} ${isDisabled ? 'disabled' : ''}>
                        <label for="skill-${skill.key}">${skill.name} (${skill.attribute.toUpperCase()})</label>
                    `;
                    skillProficiencyContainer.appendChild(div);
                });

                // Add event listeners to newly created checkboxes
                skillProficiencyContainer.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.addEventListener('change', handleSkillCheckboxChange);
                });
                updateSkillProficiencyCounter();
            }

            function handleSkillCheckboxChange(event) {
                const checkbox = event.target;
                const skillKey = checkbox.dataset.skillKey;

                // If it's disabled (and not a background proficiency), revert its state and return
                if (checkbox.disabled && !backgroundProficienciesSet.has(skillKey)) {
                    checkbox.checked = !checkbox.checked; // Revert state
                    return;
                }

                // Calculate selected user-chosen skills *after* the current change
                const allCheckboxes = Array.from(skillProficiencyContainer.querySelectorAll('input[type="checkbox"]'));
                const selectedUserSkillsCount = allCheckboxes.filter(cb =>
                    cb.checked && !backgroundProficienciesSet.has(cb.dataset.skillKey)
                ).length;

                if (checkbox.checked) {
                    // If this checkbox was just checked, and it pushes us over the limit
                    if (selectedUserSkillsCount > maxClassProficiencies) {
                        checkbox.checked = false; // Prevent selection
                    }
                }
                // Always update the counter and re-evaluate disabled states for ALL checkboxes
                updateSkillProficiencyCounter();
            }

            function updateSkillProficiencyCounter() {
                // Get ALL skill checkboxes, regardless of their current disabled state
                const allSkillCheckboxes = Array.from(skillProficiencyContainer.querySelectorAll('input[type="checkbox"]'));

                // Calculate current user-chosen skills (excluding background-granted ones)
                const selectedUserChosenSkillsCount = allSkillCheckboxes.filter(checkbox =>
                    checkbox.checked && !backgroundProficienciesSet.has(checkbox.dataset.skillKey)
                ).length;

                const remaining = maxClassProficiencies - selectedUserChosenSkillsCount;

                if (maxClassProficiencies === 0) {
                    skillProficiencyCounter.textContent = `請選擇職業以查看技能熟練選項。`;
                } else {
                    skillProficiencyCounter.textContent = `您還可以選擇 ${remaining} 個技能熟練 (共 ${maxClassProficiencies} 個)。`;
                }

                allSkillCheckboxes.forEach(checkbox => {
                    const skillKey = checkbox.dataset.skillKey;
                    const isBackgroundProficient = backgroundProficienciesSet.has(skillKey);
                    const isClassOption = classProficiencyOptions.size === 0 || classProficiencyOptions.has(skillKey);

                    if (isBackgroundProficient) {
                        checkbox.disabled = true; // Always disabled if granted by background
                        checkbox.checked = true; // Always checked if granted by background
                    } else if (!isClassOption) {
                        checkbox.disabled = true; // Disabled if not an option for the current class
                        checkbox.checked = false; // Ensure it's unchecked if not an option
                    } else {
                        // This is a user-selectable skill (not background, is a class option)
                        if (remaining <= 0 && !checkbox.checked) {
                            checkbox.disabled = true; // Disable if no more slots and not currently checked
                        } else {
                            checkbox.disabled = false; // Enable if slots available or if currently checked
                        }
                    }
                });
            }

            // --- Random Character Generation Logic ---
            randomCharacterBtn.addEventListener('click', () => {
                randomButtonClickCount++; // Increment click count for picky adventurer easter egg

                // Reset form first to ensure clean state for random generation
                charNameInput.value = '';
                playerNameInput.value = ''; // Clear player name
                charRaceSelect.value = '';
                charSubraceSelect.innerHTML = '<option value="">請選擇</option>';
                subraceContainer.classList.add('hidden');
                charClassSelect.value = '';
                charBackgroundSelect.value = '';
                charAlignmentSelect.value = '';
                
                backgroundProficienciesSet.clear();
                classProficiencyOptions.clear();
                maxClassProficiencies = 0;
                renderSkillProficiencies();
                
                availableAttributeValues = [...standardArrayValues];
                assignedAttributeValues = { str: null, dex: null, con: null, int: null, wis: null, cha: null };
                updateAttributeDropdowns();

                halfElfBonusContainer.classList.add('hidden');
                halfElfBonus1Select.innerHTML = '<option value="">請選擇</option>';
                halfElfBonus2Select.innerHTML = '<option value="">請選擇</option>';


                // 1. Random Race & Subrace
                const randomRace = getRandomElement(races);
                charRaceSelect.value = randomRace.name;
                charRaceSelect.dispatchEvent(new Event('change')); // Trigger change to update subrace/half-elf

                if (randomRace.subraces && randomRace.subraces.length > 0) {
                    charSubraceSelect.value = getRandomElement(randomRace.subraces);
                }

                // 2. Random Class
                charClassSelect.value = getRandomElement(classes);
                charClassSelect.dispatchEvent(new Event('change')); // Trigger change to update skill options

                // 3. Random Background
                charBackgroundSelect.value = getRandomElement(backgrounds);
                charBackgroundSelect.dispatchEvent(new Event('change')); // Trigger change to update skill options

                // 4. Random Alignment
                charAlignmentSelect.value = getRandomElement(alignments);

                // 5. Random Attributes
                const shuffledAttributes = shuffleArray([...standardArrayValues]);
                const attributeKeys = Object.keys(attributeSelects);
                for (let i = 0; i < attributeKeys.length; i++) {
                    const attrKey = attributeKeys[i];
                    assignedAttributeValues[attrKey] = shuffledAttributes[i];
                }
                updateAttributeDropdowns(); // Update dropdowns with assigned values

                // Handle Half-Elf bonus for random generation
                if (charRaceSelect.value === "半精靈") {
                    const nonChaAttrKeys = halfElfBonusAttributes.map(attr => attr.key);
                    const shuffledNonCha = shuffleArray([...nonChaAttrKeys]);
                    if (shuffledNonCha.length >= 2) {
                        halfElfBonus1Select.value = shuffledNonCha[0];
                        halfElfBonus2Select.value = shuffledNonCha[1];
                        updateHalfElfBonusDropdowns(); // Update dropdowns to reflect selection
                    }
                }

                // 6. Random Skills (after class and background have updated options)
                // Need a slight delay to ensure skill options are fully updated by previous change events
                setTimeout(() => {
                    const availableSkillsForUserChoice = allSkills.filter(skill =>
                        !backgroundProficienciesSet.has(skill.key) && classProficiencyOptions.has(skill.key)
                    );
                    
                    // Uncheck all user-selectable skills first
                    skillProficiencyContainer.querySelectorAll('input[type="checkbox"]:not(:disabled)').forEach(checkbox => {
                        checkbox.checked = false;
                    });

                    const skillsToChoose = [];
                    // Ensure we don't pick more than `maxClassProficiencies`
                    const numSkillsToPick = Math.min(maxClassProficiencies, availableSkillsForUserChoice.length);

                    // Randomly select skills for the user's choice
                    const shuffledAvailableSkills = shuffleArray([...availableSkillsForUserChoice]);
                    for (let i = 0; i < numSkillsToPick; i++) {
                        skillsToChoose.push(shuffledAvailableSkills[i].key);
                    }

                    // Check the randomly chosen skills
                    skillsToChoose.forEach(skillKey => {
                        const checkbox = document.getElementById(`skill-${skillKey}`);
                        if (checkbox) {
                            checkbox.checked = true;
                        }
                    });
                    updateSkillProficiencyCounter(); // Re-evaluate disabled states after random selection

                }, 100); // Small delay to allow UI updates to propagate

                // Set a random name (optional, but good for full random character)
                const randomNames = ["奧利佛", "莉莉絲", "葛雷戈", "艾拉", "芬恩", "瑟拉娜", "凱爾", "伊芙琳"];
                charNameInput.value = getRandomElement(randomNames);
                playerNameInput.value = "隨機玩家"; // Assign a default player name for random characters
            });


            // --- Character Creation Logic (shared by manual and random) ---
            function createAndDisplayCharacter() {
                const name = charNameInput.value.trim();
                const playerName = playerNameInput.value.trim();
                const race = charRaceSelect.value;
                const subrace = subraceContainer.classList.contains('hidden') ? null : charSubraceSelect.value;
                const charClass = charClassSelect.value;
                const background = charBackgroundSelect.value;
                const alignment = charAlignmentSelect.value;

                // Validate basic fields
                if (!name || !race || !charClass || !background || !alignment) {
                    newCharacterDisplay.innerHTML = '<p class="text-red-300">請填寫所有角色基本資訊。</p>';
                    return;
                }
                if (subraceContainer.classList.contains('hidden') === false && !subrace) {
                    newCharacterDisplay.innerHTML = '<p class="text-red-300">請選擇亞種。</p>';
                    return;
                }

                // Validate attribute assignments
                const finalAttributes = {};
                let allAttributesAssigned = true;
                for (const attrKey in assignedAttributeValues) {
                    if (assignedAttributeValues[attrKey] === null) {
                        allAttributesAssigned = false;
                        break;
                    }
                    finalAttributes[attrKey] = assignedAttributeValues[attrKey];
                }

                if (!allAttributesAssigned) {
                    newCharacterDisplay.innerHTML = '<p class="text-red-300">請將所有標準屬性值分配給各項屬性。</p>';
                    return;
                }

                // Apply Half-Elf bonuses
                if (race === "半精靈") {
                    if (!halfElfBonus1Select.value || !halfElfBonus2Select.value || halfElfBonus1Select.value === halfElfBonus2Select.value) {
                        newCharacterDisplay.innerHTML = '<p class="text-red-300">半精靈需要為兩個不同的非魅力屬性各選擇 +1。</p>';
                        return;
                    }
                    finalAttributes['cha'] = (finalAttributes['cha'] || 0) + 2; // CHA gets +2
                    finalAttributes[halfElfBonus1Select.value] = (finalAttributes[halfElfBonus1Select.value] || 0) + 1;
                    finalAttributes[halfElfBonus2Select.value] = (finalAttributes[halfElfBonus2Select.value] || 0) + 1;
                }

                // Get selected skill proficiencies
                const selectedProficientSkills = Array.from(skillProficiencyContainer.querySelectorAll('input[type="checkbox"]:checked')).map(checkbox => checkbox.dataset.skillKey);
                
                // Validate skill proficiency count (only for user-chosen skills)
                const userChosenSkillsCount = selectedProficientSkills.filter(skillKey => !backgroundProficienciesSet.has(skillKey)).length;
                if (userChosenSkillsCount !== maxClassProficiencies) {
                     newCharacterDisplay.innerHTML = `<p class="text-red-300">請選擇 ${maxClassProficiencies} 個額外技能熟練。</p>`;
                     return;
                }


                const newChar = {
                    name, playerName, race, subrace, charClass, background, alignment,
                    level: 1, // Default to level 1
                    currentXP: 0, // Default to 0 XP
                    str: finalAttributes.str,
                    dex: finalAttributes.dex,
                    con: finalAttributes.con,
                    int: finalAttributes.int,
                    wis: finalAttributes.wis,
                    cha: finalAttributes.cha,
                    proficiencyBonus: 2, // Default proficiency bonus for level 1
                    proficientSkills: selectedProficientSkills, // Store selected skills
                    gold: 0,
                    inventory: []
                };

                // Display the created character
                let skillsDisplay = '';
                if (newChar.proficientSkills.length > 0) {
                    skillsDisplay = '<p class="mt-2"><span class="font-bold text-dark-text">熟練技能:</span></p><ul class="list-disc list-inside ml-4 text-dark-text-secondary">';
                    newChar.proficientSkills.forEach(skillKey => {
                        const skill = allSkills.find(s => s.key === skillKey);
                        if (skill) {
                            skillsDisplay += `<li>${skill.name} (${skill.attribute.toUpperCase()})</li>`;
                        }
                    });
                    skillsDisplay += '</ul>';
                }

                // --- Easter Egg Logic ---
                let finalEasterEggMessages = []; // Use an array to store multiple messages

                // 1. General Random Easter Egg (1 in 8 chance)
                if (Math.random() < 0.125) {
                    const randomIndex = Math.floor(Math.random() * generalEasterEggMessages.length);
                    finalEasterEggMessages.push(generalEasterEggMessages[randomIndex]);
                }

                // 2. Player Name Easter Egg
                const lowerCasePlayerName = playerName.toLowerCase();
                for (const trigger in playerNameEasterEggs) {
                    if (lowerCasePlayerName.includes(trigger.toLowerCase())) { // Convert trigger to lowercase for consistent comparison
                        finalEasterEggMessages.push(playerNameEasterEggs[trigger]);
                    }
                }

                // 3. Race-Class Combination Easter Egg
                const raceClassComboKey = `${race}-${charClass}`;
                if (raceClassEasterEggs[raceClassComboKey]) {
                    finalEasterEggMessages.push(raceClassEasterEggs[raceClassComboKey]);
                }

                // 4. Specific Skill Selection Combination Easter Egg
                // 新增的技能組合彩蛋
                if (selectedProficientSkills.includes('athletics') && selectedProficientSkills.includes('intimidation')) {
                    finalEasterEggMessages.push('你的角色看起來隨時準備好一場硬仗，並且會讓敵人聞風喪膽！');
                }
                if (selectedProficientSkills.includes('arcana') && selectedProficientSkills.includes('history')) {
                    finalEasterEggMessages.push('一位對古老魔法和歷史充滿好奇的學者，知識就是力量！');
                }
                if (selectedProficientSkills.includes('medicine') && selectedProficientSkills.includes('insight')) {
                    finalEasterEggMessages.push('你不僅能治癒傷口，還能看穿人心，是隊伍中不可或缺的支援者！');
                }
                if (selectedProficientSkills.includes('stealth') && selectedProficientSkills.includes('deception')) {
                    finalEasterEggMessages.push('一個擅長隱匿和欺瞞的傢伙，是潛入和間諜任務的完美人選！');
                }
                if (selectedProficientSkills.includes('animalHandling') && selectedProficientSkills.includes('nature')) {
                    finalEasterEggMessages.push('與動物為友，與自然共鳴，你就像森林的低語者！');
                }
                if (selectedProficientSkills.includes('performance') && selectedProficientSkills.includes('persuasion')) {
                    finalEasterEggMessages.push('舞台是你的，人心也是你的，天生的表演者和說服家！');
                }
                // 新增更多技能組合彩蛋
                if (selectedProficientSkills.includes('investigation') && selectedProficientSkills.includes('perception')) {
                    finalEasterEggMessages.push('敏銳的觀察力與縝密的調查，沒有什麼能逃過你的雙眼！');
                }
                if (selectedProficientSkills.includes('survival') && selectedProficientSkills.includes('athletics')) {
                    finalEasterEggMessages.push('在野外生存的專家，無論多麼惡劣的環境都難不倒你！');
                }
                if (selectedProficientSkills.includes('religion') && selectedProficientSkills.includes('medicine')) {
                    finalEasterEggMessages.push('神聖的知識與治療的藝術，你是信仰與健康的守護者！');
                }
                if (selectedProficientSkills.includes('acrobatics') && selectedProficientSkills.includes('performance')) {
                    finalEasterEggMessages.push('靈活的身體加上精湛的表演，你就是舞台上的焦點！');
                }
                if (selectedProficientSkills.includes('sleightOfHand') && selectedProficientSkills.includes('intimidation')) {
                    finalEasterEggMessages.push('既能巧妙偷竊，又能威嚇他人，真是個危險又迷人的角色！');
                }


                // 5. Time/Date Easter Egg
                const now = new Date();
                // Correctly get month, day, and hour from the Date object
                const currentMonth = now.getMonth(); // 0-indexed
                const currentDay = now.getDate();
                const currentHour = now.getHours();

                if (currentMonth === 9 && currentDay === 31) { // October 31st (Halloween)
                    finalEasterEggMessages.push('祝您萬聖節快樂！小心那些不給糖就搗蛋的怪物！');
                } else if (currentHour >= 6 && currentHour < 11) { // 6 AM to 10:59 AM
                    finalEasterEggMessages.push('大早上開始冒險之路？非常有趕緊！');
                } else if (currentHour >= 11 && currentHour < 13) { // 11 AM to 12:59 PM
                    finalEasterEggMessages.push('帶上午餐出發吧！冒險者');
                } else if (currentHour >= 13 && currentHour < 17) { // 1 PM to 4:59 PM
                    finalEasterEggMessages.push('下午，非常適合出發冒險的時間！');
                } else if (currentHour >= 17 && currentHour < 21) { // 5 PM to 8:59 PM
                    finalEasterEggMessages.push('晚上了，出發冒險時記得帶上一盞照明的燈');
                } else if (currentHour >= 21 || (currentHour >= 0 && currentHour < 2)) { // 9 PM to 1:59 AM (next day)
                    finalEasterEggMessages.push('也許我們可以考慮休息一晚再出發冒險？');
                } else if (currentHour >= 2 && currentHour < 5) { // 2 AM to 4:59 AM (深夜彩蛋)
                    finalEasterEggMessages.push('夜深了，只有最勇敢的冒險者才會在這個時候創造角色…或者最失眠的。');
                }
                // 新增的時間/日期彩蛋
                // New Year's Day (January 1st)
                if (currentMonth === 0 && currentDay === 1) {
                    finalEasterEggMessages.push('新年快樂！願您的冒險在嶄新的一年裡充滿希望！');
                }
                // Dragon Boat Festival (Example: June 10th, 2024 - this changes yearly, so a fixed date is just an example)
                // For a more accurate date, one would need a lunar calendar library.
                // For simplicity, let's pick a common approximate date for the example.
                if (currentMonth === 5 && currentDay === 10) { // Example: June 10th (approximate for Dragon Boat Festival)
                    finalEasterEggMessages.push('端午節快樂！別忘了吃粽子，小心划龍舟別翻船！');
                }
                // Mid-Autumn Festival (Example: September 17th, 2024 - this changes yearly)
                if (currentMonth === 8 && currentDay === 17) { // Example: September 17th (approximate for Mid-Autumn Festival)
                    finalEasterEggMessages.push('中秋節快樂！願您和您的夥伴們月圓人團圓！');
                }
                // Christmas Day (December 25th)
                if (currentMonth === 11 && currentDay === 25) {
                    finalEasterEggMessages.push('聖誕快樂！願您的背包裡充滿禮物和好運！');
                }
                // April Fool's Day (April 1st)
                if (currentMonth === 3 && currentDay === 1) {
                    finalEasterEggMessages.push('愚人節快樂！希望您的冒險不會遇到太多惡作劇！');
                }


                // 6. Picky Adventurer Easter Egg (for random generation clicks)
                if (randomButtonClickCount > 10) {
                    finalEasterEggMessages.push('看來這位冒險家非常精挑細選！');
                }

                // Join all easter egg messages with " - " and add the prefix/suffix
                let easterEggDisplay = '';
                if (finalEasterEggMessages.length > 0) {
                    // Changed to format as "小精靈評語:\n- Message1\n- Message2"
                    easterEggDisplay = `<p class="mt-2 text-center text-dark-text-secondary italic">小精靈評語:<br>- ${finalEasterEggMessages.join('<br>- ')}</p>`;
                }


                newCharacterDisplay.innerHTML = `
                    <p><span class="font-bold text-dark-text">名稱:</span> <span class="text-dark-text">${newChar.name}</span></p>
                    <p><span class="font-bold text-dark-text">玩家名稱:</span> <span class="text-dark-text">${newChar.playerName || '未設定'}</span></p>
                    <p><span class="font-bold text-dark-text">種族:</span> ${newChar.race}${newChar.subrace ? ` (${newChar.subrace})` : ''}</p>
                    <p><span class="font-bold text-dark-text">職業:</span> ${newChar.charClass}</p>
                    <p><span class="font-bold text-dark-text">背景:</span> ${newChar.background}</p>
                    <p><span class="font-bold text-dark-text">陣營:</span> ${newChar.alignment}</p>
                    <p><span class="font-bold text-dark-text">等級:</span> ${newChar.level} (XP: ${newChar.currentXP})</p>
                    <p><span class="font-bold text-dark-text">熟練加值:</span> +${newChar.proficiencyBonus}</p>
                    <p class="mt-2"><span class="font-bold text-dark-text">屬性:</span></p>
                    <ul class="list-disc list-inside ml-4 text-dark-text-secondary">
                        <li>力量 (STR): ${newChar.str} (${getAttributeModifier(newChar.str)})</li>
                        <li>敏捷 (DEX): ${newChar.dex} (${getAttributeModifier(newChar.dex)})</li>
                        <li>體質 (CON): ${newChar.con} (${getAttributeModifier(newChar.con)})</li>
                        <li>智力 (INT): ${newChar.int} (${getAttributeModifier(newChar.int)})</li>
                        <li>感知 (WIS): ${newChar.wis} (${getAttributeModifier(newChar.wis)})</li>
                        <li>魅力 (CHA): ${newChar.cha} (${getAttributeModifier(newChar.cha)})</li>
                    </ul>
                    ${skillsDisplay}
                    <p class="mt-2 text-green-300 font-bold">角色創造成功！</p>
                    ${easterEggDisplay}
                `;

                // Reset form and counters after successful character creation
                charNameInput.value = '';
                playerNameInput.value = ''; // Clear player name
                charRaceSelect.value = '';
                charSubraceSelect.innerHTML = '<option value="">請選擇</option>';
                subraceContainer.classList.add('hidden');
                charClassSelect.value = '';
                charBackgroundSelect.value = '';
                charAlignmentSelect.value = '';
                
                backgroundProficienciesSet.clear();
                classProficiencyOptions.clear();
                maxClassProficiencies = 0;
                renderSkillProficiencies();
                
                availableAttributeValues = [...standardArrayValues];
                assignedAttributeValues = { str: null, dex: null, con: null, int: null, wis: null, cha: null };
                updateAttributeDropdowns();

                halfElfBonusContainer.classList.add('hidden');
                halfElfBonus1Select.innerHTML = '<option value="">請選擇</option>';
                halfElfBonus2Select.innerHTML = '<option value="">請選擇</option>';

                randomButtonClickCount = 0; // Reset picky adventurer counter
            }

            // --- Event Listeners ---
            createCharacterBtn.addEventListener('click', createAndDisplayCharacter);
            randomCharacterBtn.addEventListener('click', () => {
                randomButtonClickCount++; // Increment for random button clicks
                createAndDisplayCharacter(); // Call the shared function
            });


            // --- Initial Setup ---
            populateDropdown(charRaceSelect, races);
            populateDropdown(charClassSelect, classes);
            populateDropdown(charAlignmentSelect, alignments);
            populateDropdown(charBackgroundSelect, backgrounds);
            updateAttributeDropdowns(); // Initialize attribute dropdowns
            updateSkillProficienciesBasedOnClassAndBackground(); // Initialize skill checkboxes based on default empty selections

            // Title Click Easter Egg
            mainTitle.addEventListener('click', () => {
                const currentTime = Date.now();
                if (currentTime - titleLastClickTime < displayClickInterval) { // Reusing displayClickInterval for title
                    titleClickCount++;
                } else {
                    titleClickCount = 1; // Reset if interval is too long
                }
                titleLastClickTime = currentTime;

                clearTimeout(titleClickTimeout);
                titleClickTimeout = setTimeout(() => {
                    titleClickCount = 0; // Reset after interval if no more clicks
                }, displayClickInterval); // Reusing displayClickInterval for title

                if (titleClickCount > titleClickThreshold) { // Changed to > 5
                    const message = "哎呀別顧著點我了，快創作你的角色吧！";
                    const existingPopOut = document.getElementById('titlePopOutMessage');
                    if (existingPopOut) {
                        existingPopOut.remove(); // Remove existing one if multiple clicks
                    }

                    const popOutDiv = document.createElement('div');
                    popOutDiv.id = 'titlePopOutMessage';
                    popOutDiv.className = 'pop-out-message';
                    popOutDiv.textContent = message;

                    // Position the pop-out message relative to the title
                    const titleRect = mainTitle.getBoundingClientRect();
                    const containerRect = document.querySelector('.book-container').getBoundingClientRect(); // Get container for relative positioning

                    popOutDiv.style.left = `${titleRect.left - containerRect.left + titleRect.width / 2}px`;
                    popOutDiv.style.top = `${titleRect.top - containerRect.top + titleRect.height + 10}px`; /* Position below title + some margin */
                    popOutDiv.style.transform = 'translateX(-50%) translateY(20px) scale(0.8)'; /* Centered horizontally, slightly below, scaled down */

                    // Append to the book container for proper relative positioning within the book
                    document.querySelector('.book-container').appendChild(popOutDiv);

                    // Trigger animation
                    setTimeout(() => {
                        popOutDiv.classList.add('active');
                    }, 10); // Small delay to ensure CSS transition applies

                    // Remove after a duration
                    setTimeout(() => {
                        popOutDiv.classList.remove('active');
                        // Remove the element after the fade-out transition completes
                        popOutDiv.addEventListener('transitionend', () => {
                            popOutDiv.remove();
                        }, { once: true });
                    }, 2000); // Message visible for 2 seconds

                    titleClickCount = 0; // Reset after triggering
                }
            });

            // Continuous Click Easter Egg on newCharacterDisplay
            newCharacterDisplay.addEventListener('click', () => {
                const currentTime = Date.now();
                if (currentTime - displayLastClickTime < displayClickInterval) {
                    displayClickCount++;
                } else {
                    displayClickCount = 1; // Reset if interval is too long
                }
                displayLastClickTime = currentTime;

                clearTimeout(displayClickTimeout);
                displayClickTimeout = setTimeout(() => {
                    displayClickCount = 0; // Reset after interval if no more clicks
                }, displayClickInterval);

                if (displayClickCount >= displayClickThreshold) {
                    const message = "你是不是太無聊了？這裡沒有寶藏哦！";
                    const existingPopOut = document.getElementById('displayPopOutMessage');
                    if (existingPopOut) {
                        existingPopOut.remove();
                    }

                    const popOutDiv = document.createElement('div');
                    popOutDiv.id = 'displayPopOutMessage';
                    popOutDiv.className = 'pop-out-message';
                    popOutDiv.textContent = message;

                    // Position relative to the newCharacterDisplay
                    const displayRect = newCharacterDisplay.getBoundingClientRect();
                    const containerRect = document.querySelector('.book-container').getBoundingClientRect();

                    popOutDiv.style.left = `${displayRect.left - containerRect.left + displayRect.width / 2}px`;
                    popOutDiv.style.top = `${displayRect.top - containerRect.top + displayRect.height / 2}px`;
                    popOutDiv.style.transform = 'translateX(-50%) translateY(-50%) scale(0.8)';

                    document.querySelector('.book-container').appendChild(popOutDiv);

                    setTimeout(() => {
                        popOutDiv.classList.add('active');
                    }, 10);

                    setTimeout(() => {
                        popOutDiv.classList.remove('active');
                        popOutDiv.addEventListener('transitionend', () => {
                            popOutDiv.remove();
                        }, { once: true });
                    }, 2000);

                    displayClickCount = 0; // Reset after triggering
                }
            });
        });
    </script>
</body>
</html>
